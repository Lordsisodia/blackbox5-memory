<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RALF Real-time Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
        }

        .status-disconnected {
            background: #f44336;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 18px;
            color: #666;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .metric {
            text-align: center;
        }

        .metric-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }

        .status-healthy {
            color: #4CAF50;
        }

        .status-warning {
            color: #FF9800;
        }

        .status-critical {
            color: #f44336;
        }

        .alert {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert:last-child {
            margin-bottom: 0;
        }

        .alert-warning {
            background: #FFF3E0;
            border-left-color: #FF9800;
        }

        .alert-critical {
            background: #FFEBEE;
            border-left-color: #f44336;
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-message {
            flex: 1;
            color: #333;
        }

        .task-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .task-item {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-id {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }

        .task-title {
            color: #333;
            margin-bottom: 4px;
        }

        .task-meta {
            font-size: 12px;
            color: #888;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high {
            background: #f44336;
            color: white;
        }

        .priority-medium {
            background: #FF9800;
            color: white;
        }

        .priority-low {
            background: #4CAF50;
            color: white;
        }

        .event-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-type {
            font-weight: bold;
            color: #667eea;
            text-transform: capitalize;
        }

        .event-time {
            font-size: 12px;
            color: #888;
        }

        .no-data {
            text-align: center;
            color: #888;
            padding: 20px;
            font-style: italic;
        }

        .last-update {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ RALF Real-time Dashboard</h1>
            <div>
                <span id="connection-status" class="status-badge status-disconnected">Disconnected</span>
                <span id="update-indicator" class="status-badge" style="background: #667eea; color: white;">‚óè Live</span>
            </div>
        </div>

        <div class="grid">
            <!-- System Health Card -->
            <div class="card">
                <h2>System Health</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Queue Depth</div>
                        <div class="metric-value" id="queue-depth">-</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Active Tasks</div>
                        <div class="metric-value" id="active-tasks">-</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Planner</div>
                        <div class="metric-value" id="planner-status" style="font-size: 24px;">-</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Executor</div>
                        <div class="metric-value" id="executor-status" style="font-size: 24px;">-</div>
                    </div>
                </div>
            </div>

            <!-- Alerts Card -->
            <div class="card">
                <h2>Alerts</h2>
                <div id="alerts">
                    <div class="no-data">No alerts</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Current Queue Card -->
            <div class="card" style="grid-column: span 2;">
                <h2>Current Queue</h2>
                <ul class="task-list" id="queue-list">
                    <div class="no-data">No tasks in queue</div>
                </ul>
            </div>

            <!-- Recent Events Card -->
            <div class="card">
                <h2>Recent Events</h2>
                <ul class="task-list" id="events-list">
                    <div class="no-data">No recent events</div>
                </ul>
            </div>
        </div>

        <div class="last-update">
            Last update: <span id="last-update-time">-</span>
        </div>
    </div>

    <script>
        const WS_URL = 'ws://localhost:8765';
        let ws = null;
        let reconnectTimeout = null;

        // DOM Elements
        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            queueDepth: document.getElementById('queue-depth'),
            activeTasks: document.getElementById('active-tasks'),
            plannerStatus: document.getElementById('planner-status'),
            executorStatus: document.getElementById('executor-status'),
            alerts: document.getElementById('alerts'),
            queueList: document.getElementById('queue-list'),
            eventsList: document.getElementById('events-list'),
            lastUpdate: document.getElementById('last-update-time')
        };

        // Connect to WebSocket
        function connect() {
            console.log('Connecting to WebSocket:', WS_URL);
            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                console.log('WebSocket connected');
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.className = 'status-badge status-connected';
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            };

            ws.onmessage = function(event) {
                const state = JSON.parse(event.data);
                console.log('State update received:', state);
                updateDashboard(state);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.className = 'status-badge status-disconnected';
                // Attempt to reconnect after 5 seconds
                reconnectTimeout = setTimeout(connect, 5000);
            };
        }

        // Update dashboard with new state
        function updateDashboard(state) {
            // Update metrics
            const queue = state.queue?.queue || [];
            elements.queueDepth.textContent = queue.length;
            elements.activeTasks.textContent = queue.length;

            // Color-code queue depth
            if (queue.length === 0) {
                elements.queueDepth.className = 'metric-value status-critical';
            } else if (queue.length < 2) {
                elements.queueDepth.className = 'metric-value status-warning';
            } else {
                elements.queueDepth.className = 'metric-value status-healthy';
            }

            // Update agent status
            const heartbeats = state.heartbeat?.heartbeats || {};
            const planner = heartbeats.planner || {};
            const executor = heartbeats.executor || {};

            elements.plannerStatus.textContent = planner.status || 'unknown';
            elements.plannerStatus.className = 'metric-value ' + getStatusClass(planner.status);

            elements.executorStatus.textContent = executor.status || 'unknown';
            elements.executorStatus.className = 'metric-value ' + getStatusClass(executor.status);

            // Update alerts
            updateAlerts(state.alerts || []);

            // Update queue
            updateQueue(queue);

            // Update events
            updateEvents(state.recent_events || []);

            // Update timestamp
            elements.lastUpdate.textContent = new Date(state.timestamp).toLocaleTimeString();
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'running': return 'status-healthy';
                case 'idle': return 'status-warning';
                case 'blocked': return 'status-critical';
                default: return '';
            }
        }

        // Update alerts panel
        function updateAlerts(alerts) {
            if (!alerts || alerts.length === 0) {
                elements.alerts.innerHTML = '<div class="no-data">No alerts</div>';
                return;
            }

            elements.alerts.innerHTML = alerts.map(alert => {
                const icon = alert.severity === 'critical' ? 'üö®' : '‚ö†Ô∏è';
                return `
                    <div class="alert alert-${alert.severity}">
                        <span class="alert-icon">${icon}</span>
                        <span class="alert-message">${alert.message}</span>
                    </div>
                `;
            }).join('');
        }

        // Update queue display
        function updateQueue(queue) {
            if (!queue || queue.length === 0) {
                elements.queueList.innerHTML = '<div class="no-data">No tasks in queue</div>';
                return;
            }

            elements.queueList.innerHTML = queue.map(task => {
                const priorityClass = `priority-${(task.priority || 'low').toLowerCase()}`;
                return `
                    <li class="task-item">
                        <div>
                            <div class="task-id">${task.task_id || 'Unknown'}</div>
                            <div class="task-title">${task.title || 'No title'}</div>
                        </div>
                        <span class="priority-badge ${priorityClass}">${task.priority || 'low'}</span>
                    </li>
                `;
            }).join('');
        }

        // Update events display
        function updateEvents(events) {
            if (!events || events.length === 0) {
                elements.eventsList.innerHTML = '<div class="no-data">No recent events</div>';
                return;
            }

            elements.eventsList.innerHTML = events.map(event => {
                const time = new Date(event.timestamp || Date.now()).toLocaleTimeString();
                return `
                    <li class="event-item">
                        <div>
                            <div class="event-type">${event.type || 'unknown'}</div>
                            <div class="task-meta">${event.task_id || 'N/A'}</div>
                        </div>
                        <span class="event-time">${time}</span>
                    </li>
                `;
            }).join('');
        }

        // Start connection
        connect();

        // Handle page visibility (reconnect when tab becomes visible)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!ws || ws.readyState === WebSocket.CLOSED)) {
                connect();
            }
        });
    </script>
</body>
</html>
