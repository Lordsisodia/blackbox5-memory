#!/usr/bin/env python3
"""Update architecture dashboard with current metrics."""

import yaml
import subprocess
from datetime import datetime
from pathlib import Path

def count_empty_dirs():
    """Count empty directories."""
    result = subprocess.run(
        ['find', '/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5', '-type', 'd', '-empty'],
        capture_output=True, text=True
    )
    return len([l for l in result.stdout.strip().split('\n') if l])

def count_tasks():
    """Count active and completed tasks."""
    active = len([d for d in Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/tasks/active').iterdir() if d.is_dir() and d.name.startswith('TASK-')])
    completed = len([d for d in Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/tasks/completed').iterdir() if d.is_dir()])
    return active, completed

def count_goals():
    """Count active goals."""
    return len([d for d in Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/goals/active').iterdir() if d.is_dir() and d.name.startswith('IG-')])

def count_knowledge_files():
    """Count knowledge base files."""
    kb_path = Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/knowledge')
    if not kb_path.exists():
        return 0
    return len([f for f in kb_path.rglob('*.md')])

def get_validation_status():
    """Run validation and return status."""
    result = subprocess.run(
        ['python3', '/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/bin/validate-ssot.py'],
        capture_output=True, text=True
    )
    return '‚úÖ Passing' if '‚úÖ All validations passed' in result.stdout else '‚ùå Failed'

def get_arch_tasks():
    """Get ARCH task statuses."""
    tasks = []
    tasks_dir = Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/tasks/active')
    for task_dir in sorted(tasks_dir.glob('TASK-ARCH-*')):
        task_file = task_dir / 'task.md'
        if task_file.exists():
            with open(task_file, 'r') as f:
                content = f.read()
                # Extract title from first line
                title = content.split('\n')[0].replace('# ', '') if content.startswith('# ') else task_dir.name
                # Extract status
                status = 'pending'
                if '**Status:** completed' in content:
                    status = '‚úÖ completed'
                elif '**Status:** in_progress' in content:
                    status = 'üîÑ in_progress'
                elif '**Status:** active' in content:
                    status = 'üîÑ active'
                tasks.append((task_dir.name, title, status))
    return tasks

def generate_dashboard():
    """Generate the dashboard markdown."""
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

    # Collect metrics
    empty_dirs = count_empty_dirs()
    active_tasks, completed_tasks = count_tasks()
    active_goals = count_goals()
    kb_files = count_knowledge_files()
    validation = get_validation_status()

    # Calculate health score (0-100)
    # Empty dirs: 0 = 100 points, 50+ = 0 points
    empty_score = max(0, 100 - (empty_dirs * 2))
    # Validation: pass = 100, fail = 0
    validation_score = 100 if validation == '‚úÖ Passing' else 0
    # Overall: average
    health_score = (empty_score + validation_score) // 2

    # Get ARCH tasks
    arch_tasks = get_arch_tasks()

    # Generate dashboard
    dashboard = f"""# Architecture Dashboard

**Last Updated:** {now}

---

## üè• Health Score: {health_score}/100

| Metric | Value | Status |
|--------|-------|--------|
| Empty Directories | {empty_dirs} | {'‚úÖ' if empty_dirs < 10 else '‚ö†Ô∏è' if empty_dirs < 50 else '‚ùå'} |
| Validation | {validation} | {'‚úÖ' if validation == '‚úÖ Passing' else '‚ùå'} |

---

## üìä Project Stats

| Category | Count |
|----------|-------|
| Active Tasks | {active_tasks} |
| Completed Tasks | {completed_tasks} |
| Active Goals | {active_goals} |
| Knowledge Files | {kb_files} |

---

## üèóÔ∏è Architecture Improvement Tasks (IG-007)

| Task | Status | Description |
|------|--------|-------------|
"""

    # Add ARCH tasks
    for task_id, title, status in arch_tasks:
        short_title = title.replace('TASK-ARCH-XXX: ', '').replace('TASK-ARCH-00X: ', '').replace('TASK-ARCH-00Y: ', '')[:40]
        dashboard += f"| {task_id} | {status} | {short_title}... |\n"

    dashboard += """
---

## üìà Recent Changes

| Date | Change | Task |
|------|--------|------|
| 2026-02-04 | Standardized task naming | TASK-ARCH-007 |
| 2026-02-04 | Created STATE.yaml sync script | TASK-ARCH-006 |
| 2026-02-04 | Populated empty directories | TASK-ARCH-005 |
| 2026-02-04 | Documented SSOT pattern | TASK-ARCH-004 |
| 2026-02-04 | Fixed SSOT violations | TASK-ARCH-003 |

---

## üîÑ Auto-Update

This dashboard is auto-generated by `bin/update-dashboard.py`.

To update manually:
```bash
python3 bin/update-dashboard.py
```

---

## üìã IG-007 Goal Progress

**Goal:** Continuous Architecture Evolution & Documentation Improvement

**Progress:** 7/11 tasks completed (64%)

**Remaining:**
- TASK-ARCH-001: Create Architecture Analysis Framework
- TASK-ARCH-002: Execute First Improvement Loop
- TASK-ARCH-010: Implement Skill Metrics Collection
- TASK-ARCH-011: Create Architecture Dashboard (in progress)
"""

    return dashboard

def main():
    print("Generating architecture dashboard...")

    dashboard = generate_dashboard()

    # Write dashboard
    dashboard_path = Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/.docs/architecture-dashboard.md')
    with open(dashboard_path, 'w') as f:
        f.write(dashboard)

    print(f"‚úÖ Dashboard updated: {dashboard_path}")

if __name__ == '__main__':
    main()
