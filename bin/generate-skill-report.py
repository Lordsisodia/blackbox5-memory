#!/usr/bin/env python3
"""Generate skill effectiveness report from skill-metrics.yaml."""

import yaml
from datetime import datetime
from pathlib import Path

def load_skill_metrics():
    """Load current skill-metrics.yaml."""
    metrics_path = Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/operations/skill-metrics.yaml')
    with open(metrics_path, 'r') as f:
        return yaml.safe_load(f)

def generate_report(data):
    """Generate markdown report."""
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

    report = f"""# Skill Effectiveness Report

**Generated:** {now}
**Total Tasks Tracked:** {data['metadata'].get('total_tasks_tracked', 0)}

---

## üìä Overview

"""

    # Add ROI summary
    roi = data['analysis'].get('roi_summary', {})
    report += f"""### ROI Summary

| Metric | Value |
|--------|-------|
| Total Time Saved | {roi.get('total_time_saved_minutes', 0)} minutes |
| Avg Quality Improvement | {roi.get('avg_quality_improvement', 'N/A')} |
| Cost-Benefit Ratio | {roi.get('cost_benefit_ratio', 'N/A')} |

"""

    # Add category performance
    report += """### Category Performance

| Category | Avg Effectiveness | Total Tasks | Success Rate |
|----------|------------------|-------------|--------------|
"""

    for cat in data['analysis'].get('category_performance', []):
        avg_eff = cat.get('avg_effectiveness') or 'N/A'
        tasks = cat.get('total_tasks', 0)
        success = cat.get('success_rate') or 'N/A'
        report += f"| {cat['category']} | {avg_eff} | {tasks} | {success} |\n"

    # Add skills table
    report += """
---

## üéØ Skills

| Skill | Category | Effectiveness | Success Rate | Trigger Accuracy | Confidence |
|-------|----------|---------------|--------------|------------------|------------|
"""

    # Sort by effectiveness score
    skills = sorted(data['skills'],
                   key=lambda x: x.get('effectiveness_score') or 0,
                   reverse=True)

    for skill in skills:
        name = skill['name']
        cat = skill['category']
        eff = skill.get('effectiveness_score') or 'N/A'

        metrics = skill.get('metrics', {})
        success = metrics.get('success_rate') or 'N/A'
        trigger = metrics.get('trigger_accuracy') or 'N/A'

        conf = skill.get('recommendations', {}).get('confidence', 'low')

        report += f"| {name} | {cat} | {eff} | {success} | {trigger} | {conf} |\n"

    # Add recommendations
    report += """
---

## üí° Recommendations

### When to Use Each Skill

"""

    for skill in skills[:10]:  # Top 10
        rec = skill.get('recommendations', {})
        if rec.get('when_to_use'):
            report += f"**{skill['name']}**\n"
            report += f"- Use: {rec['when_to_use']}\n"
            report += f"- Avoid: {rec.get('when_to_avoid', 'N/A')}\n"
            report += f"- Confidence: {rec.get('confidence', 'low')}\n\n"

    # Add recent task outcomes
    report += """---

## üìù Recent Task Outcomes

| Task | Skill | Duration | Outcome | Quality |
|------|-------|----------|---------|---------|
"""

    for outcome in data.get('task_outcomes', [])[-10:]:  # Last 10
        task = outcome.get('task_id', 'N/A')
        skill = outcome.get('skill_used') or 'none'
        duration = outcome.get('duration_minutes', 'N/A')
        result = outcome.get('outcome', 'N/A')
        quality = outcome.get('quality_rating', 'N/A')
        report += f"| {task} | {skill} | {duration} | {result} | {quality} |\n"

    report += f"""
---

## üîÑ Next Calculation

**Due:** {data['metadata'].get('next_calculation_due', 'N/A')}

---

*Report generated by `bin/generate-skill-report.py`*
"""

    return report

def main():
    print("=" * 60)
    print("Skill Effectiveness Report Generation")
    print("=" * 60)

    # Load data
    print("\n[INFO] Loading skill-metrics.yaml...")
    data = load_skill_metrics()

    # Generate report
    print("[INFO] Generating report...")
    report = generate_report(data)

    # Save report
    report_path = Path('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/.docs/skill-effectiveness-report.md')
    with open(report_path, 'w') as f:
        f.write(report)

    print(f"\n‚úÖ Report saved: {report_path}")
    print("=" * 60)

if __name__ == '__main__':
    main()
