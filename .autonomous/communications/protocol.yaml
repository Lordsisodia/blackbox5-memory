# Dual-RALF Communication Protocol
# =============================================================================
# Purpose: Rules of engagement for Planner and Executor agents
# Version: 1.0.0
# Status: Active
# =============================================================================

meta:
  version: "1.0.0"
  last_updated: "2026-02-01"
  protocol_name: "Dual-RALF File-Based Communication"
  max_agents: 2  # Current limit, scalable per architecture doc

# =============================================================================
# AGENT DEFINITIONS
# =============================================================================

agents:
  planner:
    id: ralf-planner
    role: planning
    responsibilities:
      - task_planning
      - codebase_analysis
      - organization
      - pattern_recognition
      - documentation
    loop_interval_seconds: 30
    queue_depth_target: 5
    queue_depth_min: 2

  executor:
    id: ralf-executor
    role: execution
    responsibilities:
      - task_execution
      - git_operations
      - status_reporting
      - state_updates
    loop_interval_seconds: 30
    idle_timeout_minutes: 5

# =============================================================================
# FILE SPECIFICATIONS
# =============================================================================

files:
  queue:
    path: "communications/queue.yaml"
    format: yaml
    written_by: planner
    read_by: executor
    update_strategy: atomic_write
    max_tasks: 10
    fields:
      - id
      - type
      - title
      - priority
      - estimated_minutes
      - context_level
      - depends_on

  events:
    path: "communications/events.yaml"
    format: yaml
    written_by: executor
    read_by: planner
    update_strategy: append_only
    max_history: 100
    event_types:
      - started
      - progress
      - completed
      - failed
      - blocked
      - discovery
      - idle

  chat_log:
    path: "communications/chat-log.yaml"
    format: yaml
    written_by: both
    read_by: both
    update_strategy: append_only
    max_messages: 50
    message_types:
      - question
      - answer
      - warning
      - discovery
      - context
      - plan_change

  heartbeat:
    path: "communications/heartbeat.yaml"
    format: yaml
    written_by: both
    read_by: both
    update_strategy: overwrite
    timeout_seconds: 120

# =============================================================================
# COMMUNICATION RULES
# =============================================================================

rules:
  # ---------------------------------------------------------------------------
  # Planner Rules
  # ---------------------------------------------------------------------------
  planner:
    must:
      - maintain_queue_depth_between_2_and_5
      - respond_to_chat_questions_within_2_minutes
      - read_all_events_before_updating_queue
      - write_heartbeat_every_30_seconds
      - update_timestamp_on_queue_change

    must_not:
      - write_to_events_yaml
      - modify_executor_run_directory
      - commit_code_directly
      - set_queue_depth_above_10

    should:
      - analyze_codebase_when_queue_full
      - reorganize_files_during_idle
      - document_patterns_discovered
      - warn_executor_about_known_issues

  # ---------------------------------------------------------------------------
  # Executor Rules
  # ---------------------------------------------------------------------------
  executor:
    must:
      - read_queue_before_each_execution
      - write_event_on_status_change
      - write_heartbeat_every_30_seconds
      - ask_questions_via_chat_when_unclear
      - update_state_yaml_on_completion

    must_not:
      - modify_queue_yaml
      - modify_planner_run_directory
      - plan_new_tasks
      - execute_blocked_tasks

    should:
      - report_progress_every_10_percent
      - share_discoveries_via_chat
      - suggest_improvements_to_planner
      - request_context_level_3_when_needed

  # ---------------------------------------------------------------------------
  # Shared Rules
  # ---------------------------------------------------------------------------
  shared:
    must:
      - use_atomic_file_writes
      - validate_yaml_before_write
      - handle_file_locks_gracefully
      - log_errors_to_runs_directory

    must_not:
      - delete_communication_files
      - write_directly_to_git_without_skill
      - bypass_state_management_skill

# =============================================================================
# CONFLICT RESOLUTION
# =============================================================================

conflict_resolution:
  state_yaml_disagreement:
    description: "Both agents have different views of STATE.yaml"
    resolution: "Planner wins on planning section, Executor wins on execution section"
    merge_strategy: "section_based"

  queue_empty:
    description: "Executor ready but no tasks in queue"
    resolution: "Executor writes 'idle' event, waits. Planner emergency planning mode."
    timeout: "5 minutes before alert"

  executor_blocked:
    description: "Executor cannot proceed with current task"
    resolution: "Executor writes 'blocked' event with reason. Planner analyzes and replans."
    timeout: "10 minutes before Planner switches to execution mode"

  both_crashed:
    description: "Both agents unresponsive"
    resolution: "External monitor restarts both, preserves queue and state"
    recovery: "Read last known good state from git"

# =============================================================================
# SCALING NOTES
# =============================================================================

scaling:
  current:
    agents: 2
    method: file_based
    queue: single_shared

  future_3_to_5_agents:
    method: sqlite_database
    queue: partitioned_by_type
    changes:
      - "Move from YAML files to SQLite"
      - "Add agent_id to all events"
      - "Implement proper transactions"

  future_10_plus_agents:
    method: redis_message_queue
    queue: pub_sub_with_channels
    changes:
      - "Redis for real-time communication"
      - "Separate processes/pods per agent"
      - "Load balancer for Executors"

# =============================================================================
# FAILURE MODES
# =============================================================================

failure_modes:
  planner_crash:
    detection: "heartbeat > 2 minutes old"
    executor_action: "drain_queue_then_pause"
    recovery: "restart_planner_from_last_state"

  executor_crash:
    detection: "heartbeat > 2 minutes old"
    planner_action: "pause_queue_addition"
    recovery: "restart_executor_resume_queue"

  file_corruption:
    detection: "yaml_parse_error"
    action: "rename_corrupted_file_create_new"
    backup: "git_history_provides_backup"

  deadlock:
    detection: "both_waiting_for_each_other"
    action: "timeout_after_5_minutes_force_continue"
    prevention: "never_block_on_read"

# =============================================================================
# METRICS AND MONITORING
# =============================================================================

metrics:
  queue_depth:
    target: 3-5
    alert_if_below: 2
    alert_if_above: 8

  event_latency:
    description: "Time from event creation to Planner reading"
    target: "< 30 seconds"

  chat_response_time:
    description: "Time from question to answer"
    target: "< 2 minutes"

  heartbeat_age:
    alert_if_above: "120 seconds"

# =============================================================================
# CHANGE LOG
# =============================================================================

changelog:
  - version: "1.0.0"
    date: "2026-02-01"
    changes:
      - "Initial protocol for 2-agent system"
      - "File-based communication specification"
      - "Scaling roadmap to 10+ agents"
